name: Frida Gadget Release

on:
  schedule:
    # Chạy mỗi ngày lúc 00:00 UTC để kiểm tra phiên bản mới
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Cho phép chạy thủ công

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Get latest Frida version
        id: frida-version
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/frida/frida/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Frida version: $LATEST_VERSION"
          
      - name: Check if release exists
        id: check-release
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $VERSION does not exist"
          fi
          
      - name: Download Frida Gadgets
        if: steps.check-release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          mkdir -p downloads/android downloads/ios downloads/linux
          
          # Android architectures
          echo "Downloading Android gadgets..."
          curl -L -o downloads/android/frida-gadget-android-arm.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-arm.so.xz"
          curl -L -o downloads/android/frida-gadget-android-arm64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-arm64.so.xz"
          curl -L -o downloads/android/frida-gadget-android-x86.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-x86.so.xz"
          curl -L -o downloads/android/frida-gadget-android-x86_64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-x86_64.so.xz"
          
          # iOS architectures
          echo "Downloading iOS gadgets..."
          curl -L -o downloads/ios/frida-gadget-ios-universal.dylib.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-ios-universal.dylib.xz"
          
          # Linux architectures
          echo "Downloading Linux gadgets..."
          curl -L -o downloads/linux/frida-gadget-linux-x86.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-x86.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-x86_64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-x86_64.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-arm.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-arm.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-arm64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-arm64.so.xz"
          
      - name: Extract and compress gadgets
        if: steps.check-release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          
          # Extract all .xz files
          echo "Extracting files..."
          find downloads -name "*.xz" -exec xz -d {} \;
          
          # Create compressed archives for each platform
          echo "Creating platform archives..."
          cd downloads/android && zip -r ../../frida-gadget-${VERSION}-android.zip . && cd ../..
          cd downloads/ios && zip -r ../../frida-gadget-${VERSION}-ios.zip . && cd ../..
          cd downloads/linux && zip -r ../../frida-gadget-${VERSION}-linux.zip . && cd ../..
          
          # Create all-in-one archive
          cd downloads && zip -r ../frida-gadget-${VERSION}-all-platforms.zip . && cd ..
          
          echo "Archives created successfully"
          ls -lh *.zip
          
      - name: Create Release
        if: steps.check-release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.frida-version.outputs.version }}
          name: Frida Gadget ${{ steps.frida-version.outputs.version }}
          body: |
            ## Frida Gadget ${{ steps.frida-version.outputs.version }}
            
            Phiên bản Frida Gadget được tự động đóng gói từ [Frida Release chính thức](https://github.com/frida/frida/releases/tag/${{ steps.frida-version.outputs.version }})
            
            ### Nền tảng được hỗ trợ:
            
            #### Android
            - ARM (32-bit)
            - ARM64 (64-bit)
            - x86 (32-bit)
            - x86_64 (64-bit)
            
            #### iOS
            - Universal (ARM64)
            
            #### Linux
            - x86 (32-bit)
            - x86_64 (64-bit)
            - ARM (32-bit)
            - ARM64 (64-bit)
            
            ### Tải xuống:
            - `frida-gadget-*-android.zip` - Tất cả kiến trúc Android
            - `frida-gadget-*-ios.zip` - Kiến trúc iOS
            - `frida-gadget-*-linux.zip` - Tất cả kiến trúc Linux
            - `frida-gadget-*-all-platforms.zip` - Tất cả nền tảng
            
          files: |
            frida-gadget-${{ steps.frida-version.outputs.version }}-android.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-ios.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-linux.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-all-platforms.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Workflow completed
        run: |
          if [ "${{ steps.check-release.outputs.exists }}" = "true" ]; then
            echo "✅ Release already exists, no action needed"
          else
            echo "✅ New release created successfully"
          fi
