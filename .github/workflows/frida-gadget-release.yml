name: Frida Gadget Release

on:
  schedule:
    # Cháº¡y má»—i ngÃ y lÃºc 00:00 UTC Ä‘á»ƒ kiá»ƒm tra phiÃªn báº£n má»›i
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Cho phÃ©p cháº¡y thá»§ cÃ´ng

# ThÃªm permissions Ä‘á»ƒ workflow cÃ³ thá»ƒ táº¡o release vÃ  commit
permissions:
  contents: write
  
jobs:
  check-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get latest Frida version
        id: frida-version
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/frida/frida/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Frida version: $LATEST_VERSION"
          
      - name: Check current version in repo
        id: check-version
        run: |
          # Táº¡o file version.txt náº¿u chÆ°a tá»“n táº¡i
          if [ ! -f version.txt ]; then
            echo "none" > version.txt
            echo "Version file not found, creating new one"
          fi
          
          CURRENT_VERSION=$(cat version.txt)
          LATEST_VERSION="${{ steps.frida-version.outputs.version }}"
          
          echo "Current version in repo: $CURRENT_VERSION"
          echo "Latest version from Frida: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "is_new=false" >> $GITHUB_OUTPUT
            echo "No new version available"
          else
            echo "is_new=true" >> $GITHUB_OUTPUT
            echo "New version detected!"
          fi
          
      - name: Download Frida Gadgets
        if: steps.check-version.outputs.is_new == 'true'
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          mkdir -p downloads/android downloads/ios downloads/linux
          
          # Android architectures
          echo "Downloading Android gadgets..."
          curl -L -o downloads/android/frida-gadget-android-arm.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-arm.so.xz"
          curl -L -o downloads/android/frida-gadget-android-arm64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-arm64.so.xz"
          curl -L -o downloads/android/frida-gadget-android-x86.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-x86.so.xz"
          curl -L -o downloads/android/frida-gadget-android-x86_64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-android-x86_64.so.xz"
          
          # iOS architectures
          echo "Downloading iOS gadgets..."
          curl -L -o downloads/ios/frida-gadget-ios-universal.dylib.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-ios-universal.dylib.xz"
          
          # Linux architectures
          echo "Downloading Linux gadgets..."
          curl -L -o downloads/linux/frida-gadget-linux-x86.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-x86.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-x86_64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-x86_64.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-arm.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-arm.so.xz"
          curl -L -o downloads/linux/frida-gadget-linux-arm64.so.xz \
            "https://github.com/frida/frida/releases/download/${VERSION}/frida-gadget-${VERSION}-linux-arm64.so.xz"
          
      - name: Extract and compress gadgets
        if: steps.check-version.outputs.is_new == 'true'
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          
          # Extract all .xz files
          echo "Extracting files..."
          find downloads -name "*.xz" -exec xz -d {} \;
          
          # Create compressed archives for each platform
          echo "Creating platform archives..."
          cd downloads/android && zip -r ../../frida-gadget-${VERSION}-android.zip . && cd ../..
          cd downloads/ios && zip -r ../../frida-gadget-${VERSION}-ios.zip . && cd ../..
          cd downloads/linux && zip -r ../../frida-gadget-${VERSION}-linux.zip . && cd ../..
          
          # Create all-in-one archive
          cd downloads && zip -r ../frida-gadget-${VERSION}-all-platforms.zip . && cd ..
          
          echo "Archives created successfully"
          ls -lh *.zip
          
      - name: Create Release
        if: steps.check-version.outputs.is_new == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.frida-version.outputs.version }}
          name: Frida Gadget ${{ steps.frida-version.outputs.version }}
          body: |
            ## Frida Gadget ${{ steps.frida-version.outputs.version }}
            
            PhiÃªn báº£n Frida Gadget Ä‘Æ°á»£c tá»± Ä‘á»™ng Ä‘Ã³ng gÃ³i tá»« [Frida Release chÃ­nh thá»©c](https://github.com/frida/frida/releases/tag/${{ steps.frida-version.outputs.version }})
            
            ### Ná»n táº£ng Ä‘Æ°á»£c há»— trá»£:
            
            #### Android
            - ARM (32-bit)
            - ARM64 (64-bit)
            - x86 (32-bit)
            - x86_64 (64-bit)
            
            #### iOS
            - Universal (ARM64)
            
            #### Linux
            - x86 (32-bit)
            - x86_64 (64-bit)
            - ARM (32-bit)
            - ARM64 (64-bit)
            
            ### Táº£i xuá»‘ng:
            - `frida-gadget-*-android.zip` - Táº¥t cáº£ kiáº¿n trÃºc Android
            - `frida-gadget-*-ios.zip` - Kiáº¿n trÃºc iOS
            - `frida-gadget-*-linux.zip` - Táº¥t cáº£ kiáº¿n trÃºc Linux
            - `frida-gadget-*-all-platforms.zip` - Táº¥t cáº£ ná»n táº£ng
            
            ---
            
            **Cáº­p nháº­t tá»± Ä‘á»™ng:** $(date -u '+%Y-%m-%d %H:%M:%S') UTC
            
          files: |
            frida-gadget-${{ steps.frida-version.outputs.version }}-android.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-ios.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-linux.zip
            frida-gadget-${{ steps.frida-version.outputs.version }}-all-platforms.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          
      - name: Update version file
        if: steps.check-version.outputs.is_new == 'true'
        run: |
          VERSION="${{ steps.frida-version.outputs.version }}"
          echo "$VERSION" > version.txt
          
          # Táº¡o file chi tiáº¿t vá»›i thÃ´ng tin Ä‘áº§y Ä‘á»§
          cat > version-info.json << EOF
          {
            "version": "$VERSION",
            "updated_at": "$(date -u '+%Y-%m-%d %H:%M:%S') UTC",
            "release_url": "https://github.com/${{ github.repository }}/releases/tag/$VERSION",
            "frida_release_url": "https://github.com/frida/frida/releases/tag/$VERSION",
            "platforms": {
              "android": ["arm", "arm64", "x86", "x86_64"],
              "ios": ["universal"],
              "linux": ["x86", "x86_64", "arm", "arm64"]
            }
          }
          EOF
          
          echo "Version file updated to $VERSION"
          cat version.txt
          echo "Version info:"
          cat version-info.json
          
      - name: Commit and push version file
        if: steps.check-version.outputs.is_new == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add version.txt version-info.json
          git commit -m "ðŸš€ Update Frida version to ${{ steps.frida-version.outputs.version }}"
          git push
          
      - name: Workflow completed
        run: |
          if [ "${{ steps.check-version.outputs.is_new }}" = "true" ]; then
            echo "âœ… New version ${{ steps.frida-version.outputs.version }} released successfully"
          else
            echo "âœ… No new version available. Current version is up to date."
          fi
